<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tech Recon - Real-time Monitoring</title>
    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --background: 0 0% 100%;
            --foreground: 222.2 84% 4.9%;
            --card: 0 0% 100%;
            --card-foreground: 222.2 84% 4.9%;
            --popover: 0 0% 100%;
            --popover-foreground: 222.2 84% 4.9%;
            --primary: 221.2 83.2% 53.3%;
            --primary-foreground: 210 40% 98%;
            --secondary: 210 40% 96.1%;
            --secondary-foreground: 222.2 47.4% 11.2%;
            --muted: 210 40% 96.1%;
            --muted-foreground: 215.4 16.3% 46.9%;
            --accent: 210 40% 96.1%;
            --accent-foreground: 222.2 47.4% 11.2%;
            --destructive: 0 84.2% 60.2%;
            --destructive-foreground: 210 40% 98%;
            --border: 214.3 31.8% 91.4%;
            --input: 214.3 31.8% 91.4%;
            --ring: 221.2 83.2% 53.3%;
            --radius: 0.5rem;
            --success: 142.1 76.2% 36.3%;
            --warning: 38 92% 50%;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: hsl(var(--secondary));
            color: hsl(var(--foreground));
            min-height: 100vh;
            padding: 1.5rem;
            line-height: 1.5;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
        }

        .header {
            padding: 0.5rem 0 1.5rem 0;
            margin-bottom: 1.5rem;
            border-bottom: 1px solid hsl(var(--border));
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header-title {
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
        }

        .header h1 {
            font-size: 2rem;
            font-weight: 700;
            color: hsl(var(--foreground));
            letter-spacing: -0.05em;
        }

        .header p {
            font-size: 0.875rem;
            color: hsl(var(--muted-foreground));
        }

        .main-content {
            display: grid;
            grid-template-columns: 1.5fr 1fr;
            gap: 1.5rem;
            min-height: 70vh;
        }

        .log-section {
            background: hsl(var(--card));
            border: 1px solid hsl(var(--border));
            border-radius: var(--radius);
            padding: 1.5rem;
            display: flex;
            flex-direction: column;
            box-shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1), 0 1px 2px -1px rgb(0 0 0 / 0.1);
        }

        .log-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid hsl(var(--border));
        }

        .log-header h2 {
            color: hsl(var(--foreground));
            font-size: 1.25rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .status-badge {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.375rem 0.875rem;
            border-radius: 9999px;
            font-weight: 500;
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            transition: all 0.2s ease;
        }

        .status-idle {
            background: hsl(var(--muted));
            color: hsl(var(--muted-foreground));
            border: 1px solid hsl(var(--border));
        }

        .status-running {
            background: hsl(var(--success) / 0.1);
            color: hsl(var(--success));
            border: 1px solid hsl(var(--success) / 0.3);
        }

        .status-running::before {
            content: '';
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: hsl(var(--success));
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }

        .status-error {
            background: hsl(var(--destructive) / 0.1);
            color: hsl(var(--destructive));
            border: 1px solid hsl(var(--destructive) / 0.3);
        }

        .status-completed {
            background: hsl(var(--success) / 0.1);
            color: hsl(var(--success));
            border: 1px solid hsl(var(--success) / 0.3);
        }

        @keyframes pulse {
            0%, 100% {
                opacity: 1;
                transform: scale(1);
            }
            50% {
                opacity: 0.5;
                transform: scale(1.1);
            }
        }

        @keyframes spin {
            from {
                transform: rotate(0deg);
            }
            to {
                transform: rotate(360deg);
            }
        }

        .spinner {
            animation: spin 1s linear infinite;
        }

        .log-container {
            flex: 1;
            background: hsl(222.2 84% 4.9%);
            border: 1px solid hsl(217.2 32.6% 17.5%);
            border-radius: calc(var(--radius) - 2px);
            padding: 1rem;
            overflow-y: auto;
            max-height: 600px;
            font-family: 'JetBrains Mono', 'Consolas', 'Monaco', 'Courier New', monospace;
            font-size: 0.8125rem;
            line-height: 1.6;
            color: hsl(210 40% 98%);
            box-shadow: inset 0 2px 4px 0 rgb(0 0 0 / 0.3);
        }

        .log-container::-webkit-scrollbar {
            width: 8px;
        }

        .log-container::-webkit-scrollbar-track {
            background: hsl(222.2 84% 4.9%);
        }

        .log-container::-webkit-scrollbar-thumb {
            background: hsl(217.2 32.6% 17.5%);
            border-radius: 4px;
        }

        .log-container::-webkit-scrollbar-thumb:hover {
            background: hsl(217.2 32.6% 25%);
        }

        .log-entry {
            margin-bottom: 0.5rem;
            padding: 0.375rem 0.5rem;
            border-radius: calc(var(--radius) - 4px);
            color: hsl(210 40% 98%);
            transition: background-color 0.15s ease;
        }

        .log-entry:hover {
            background: hsl(217.2 32.6% 17.5% / 0.5);
        }

        .log-timestamp {
            color: hsl(215 20.2% 65.1%);
            font-size: 0.75rem;
            margin-right: 0.5rem;
        }

        .log-text { color: hsl(210 40% 98%); }
        .log-reasoning { color: hsl(210 40% 98%); }
        .log-tool { color: hsl(210 40% 98%); }
        .log-tool_result { color: hsl(210 40% 98%); }
        .log-error {
            color: hsl(0 84.2% 60.2%);
            background: hsl(0 84.2% 60.2% / 0.1);
            border-left: 2px solid hsl(0 84.2% 60.2%);
        }
        .log-success {
            color: hsl(142.1 76.2% 50%);
            font-weight: 500;
        }
        .log-system {
            color: hsl(263.4 70% 50.4%);
            font-weight: 500;
        }

        .control-section {
            background: hsl(var(--card));
            border: 1px solid hsl(var(--border));
            border-radius: var(--radius);
            padding: 1.5rem;
            box-shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1), 0 1px 2px -1px rgb(0 0 0 / 0.1);
        }

        .control-section h2 {
            color: hsl(var(--foreground));
            margin-bottom: 1.5rem;
            font-size: 1.25rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .control-group {
            margin-bottom: 1.5rem;
        }

        .control-group label {
            display: block;
            margin-bottom: 0.75rem;
            font-weight: 500;
            font-size: 0.875rem;
            color: hsl(var(--foreground));
        }

        .button-group {
            display: flex;
            gap: 0.75rem;
            margin-bottom: 0.75rem;
        }

        button {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 0.625rem 1rem;
            border: 1px solid transparent;
            border-radius: var(--radius);
            font-size: 0.875rem;
            font-weight: 500;
            font-family: inherit;
            cursor: pointer;
            transition: all 0.15s ease;
            flex: 1;
            white-space: nowrap;
        }

        button:hover {
            opacity: 0.9;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
        }

        button:active {
            transform: scale(0.98);
        }

        button:focus-visible {
            outline: 2px solid hsl(var(--ring));
            outline-offset: 2px;
        }

        .btn-primary {
            background: hsl(var(--primary));
            color: hsl(var(--primary-foreground));
            box-shadow: 0 1px 2px 0 rgb(0 0 0 / 0.05);
        }

        .btn-primary:hover {
            background: hsl(var(--primary) / 0.9);
        }

        .btn-success {
            background: hsl(var(--success));
            color: white;
            box-shadow: 0 1px 2px 0 rgb(0 0 0 / 0.05);
        }

        .btn-success:hover {
            background: hsl(var(--success) / 0.9);
        }

        .btn-secondary {
            background: hsl(var(--secondary));
            color: hsl(var(--secondary-foreground));
            border: 1px solid hsl(var(--border));
        }

        .btn-secondary:hover {
            background: hsl(var(--accent));
        }

        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            pointer-events: none;
        }

        .files-section {
            background: hsl(var(--muted) / 0.5);
            border: 1px solid hsl(var(--border));
            border-radius: calc(var(--radius) - 2px);
            padding: 1rem;
            margin-top: 1.5rem;
        }

        .files-section h3 {
            color: hsl(var(--foreground));
            margin-bottom: 1rem;
            font-size: 1rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .file-list {
            max-height: 300px;
            overflow-y: auto;
        }

        .file-list::-webkit-scrollbar {
            width: 6px;
        }

        .file-list::-webkit-scrollbar-track {
            background: transparent;
        }

        .file-list::-webkit-scrollbar-thumb {
            background: hsl(var(--border));
            border-radius: 3px;
        }

        .file-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem;
            border-bottom: 1px solid hsl(var(--border));
            transition: all 0.15s ease;
        }

        .file-item:last-child {
            border-bottom: none;
        }

        .file-item:hover {
            background: hsl(var(--accent));
        }

        .file-info {
            flex: 1;
            min-width: 0;
        }

        .file-name {
            font-weight: 500;
            font-size: 0.875rem;
            color: hsl(var(--foreground));
            margin-bottom: 0.25rem;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .file-meta {
            font-size: 0.75rem;
            color: hsl(var(--muted-foreground));
        }

        .file-part {
            display: inline-block;
            padding: 0.125rem 0.5rem;
            border-radius: 9999px;
            font-size: 0.6875rem;
            font-weight: 600;
            margin-right: 0.5rem;
            text-transform: uppercase;
            letter-spacing: 0.025em;
        }

        .part1-badge {
            background: hsl(199 89% 95%);
            color: hsl(199 89% 40%);
        }

        .part2-badge {
            background: hsl(336 100% 95%);
            color: hsl(336 78% 42%);
        }

        .download-btn {
            padding: 0.375rem 0.75rem;
            background: hsl(var(--primary));
            color: hsl(var(--primary-foreground));
            border: none;
            border-radius: calc(var(--radius) - 2px);
            cursor: pointer;
            font-size: 0.75rem;
            font-weight: 500;
            transition: all 0.15s ease;
            flex-shrink: 0;
        }

        .download-btn:hover {
            background: hsl(var(--primary) / 0.9);
            box-shadow: 0 2px 4px -1px rgb(0 0 0 / 0.1);
        }

        .download-btn:active {
            transform: scale(0.95);
        }

        .empty-state {
            text-align: center;
            padding: 2.5rem;
            color: hsl(var(--muted-foreground));
            font-size: 0.875rem;
        }

        .agent-status-section {
            background: hsl(var(--muted) / 0.3);
            border: 1px solid hsl(var(--border));
            border-radius: calc(var(--radius) - 2px);
            padding: 1rem;
            margin-bottom: 1.5rem;
        }

        .agent-status-section h3 {
            color: hsl(var(--foreground));
            font-size: 0.875rem;
            font-weight: 600;
            margin-bottom: 0.75rem;
        }

        .agent-progress {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 0.5rem;
        }

        .agent-step {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem;
            background: hsl(var(--card));
            border: 1px solid hsl(var(--border));
            border-radius: calc(var(--radius) - 2px);
            transition: all 0.15s ease;
        }

        .agent-step.pending {
            opacity: 0.6;
        }

        .agent-step.running {
            background: hsl(var(--primary) / 0.05);
            border-color: hsl(var(--primary) / 0.3);
        }

        .agent-step.completed {
            background: hsl(var(--success) / 0.05);
            border-color: hsl(var(--success) / 0.3);
        }

        .agent-step-icon {
            width: 28px;
            height: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: calc(var(--radius) - 2px);
            background: hsl(var(--muted));
            color: hsl(var(--muted-foreground));
            flex-shrink: 0;
        }

        .agent-step-icon svg {
            width: 14px;
            height: 14px;
        }

        .agent-step.running .agent-step-icon {
            background: hsl(var(--primary) / 0.15);
            color: hsl(var(--primary));
        }

        .agent-step.running .agent-step-icon svg {
            animation: spin 1s linear infinite;
        }

        .agent-step.completed .agent-step-icon {
            background: hsl(var(--success) / 0.15);
            color: hsl(var(--success));
        }

        .agent-step-content {
            flex: 1;
            min-width: 0;
        }

        .agent-step-name {
            font-size: 0.75rem;
            font-weight: 500;
            color: hsl(var(--foreground));
        }

        .agent-step-status {
            font-size: 0.6875rem;
            color: hsl(var(--muted-foreground));
            margin-top: 0.0625rem;
        }

        .agent-step.running .agent-step-status {
            color: hsl(var(--primary));
            font-weight: 500;
        }

        .agent-step.completed .agent-step-status {
            color: hsl(var(--success));
            font-weight: 500;
        }

        .log-controls {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 0.75rem;
        }

        .log-controls button {
            padding: 0.5rem 0.875rem;
            font-size: 0.8125rem;
            flex: 0 1 auto;
        }

        @media (max-width: 1024px) {
            .main-content {
                grid-template-columns: 1fr;
            }

            .header-content {
                flex-direction: column;
                align-items: flex-start;
                gap: 1rem;
            }

            .button-group {
                flex-direction: column;
            }
        }

        .connection-status {
            position: fixed;
            bottom: 1.5rem;
            right: 1.5rem;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.625rem 1rem;
            border-radius: 9999px;
            font-size: 0.8125rem;
            font-weight: 500;
            box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
            backdrop-filter: blur(8px);
            z-index: 50;
        }

        .connection-status::before {
            content: '';
            width: 8px;
            height: 8px;
            border-radius: 50%;
        }

        .connected {
            background: hsl(var(--success) / 0.95);
            color: white;
            border: 1px solid hsl(var(--success));
        }

        .connected::before {
            background: white;
        }

        .disconnected {
            background: hsl(var(--destructive) / 0.95);
            color: white;
            border: 1px solid hsl(var(--destructive));
        }

        .disconnected::before {
            background: white;
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="header-content">
                <div class="header-title">
                    <h1>ðŸš€ Tech Recon - Emerging Technology Reconnaissance System</h1>
                    <p></p>
                </div>
                <span id="statusBadge" class="status-badge status-idle">Ready</span>
            </div>
        </div>

        <div class="main-content">
            <!-- Log Section -->
            <div class="log-section">
                <div class="log-header">
                    <h2>
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M3 3v18h18"/>
                            <path d="M18 17V9"/>
                            <path d="M13 17V5"/>
                            <path d="M8 17v-3"/>
                        </svg>
                        Real-time Logs
                    </h2>
                    <div class="log-controls">
                        <button onclick="clearLogs()" class="btn-secondary">Clear</button>
                        <button onclick="toggleAutoScroll()" class="btn-secondary" id="autoScrollBtn">Auto-scroll: ON</button>
                    </div>
                </div>

                <div class="log-container" id="logContainer">
                    <div class="log-entry log-system">
                        <span class="log-timestamp"></span>
                        <span>System ready. Select Part1 or Part2 to execute.</span>
                    </div>
                </div>
            </div>

            <!-- Control Section -->
            <div class="control-section">
                <h2>
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.08a2 2 0 0 1-1-1.74v-.5a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/>
                        <circle cx="12" cy="12" r="3"/>
                    </svg>
                    Control Panel
                </h2>

                <div class="agent-status-section">
                    <h3>Agent Status</h3>
                    <div class="agent-progress">
                        <div class="agent-step pending" id="agent-planner">
                            <div class="agent-step-icon">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <path d="M9 5H2v7l6.29 6.29c.94.94 2.48.94 3.42 0l3.58-3.58c.94-.94.94-2.48 0-3.42L9 5Z"/>
                                    <path d="M6 9.01V9"/>
                                    <path d="m15 5 6.3 6.3a2.4 2.4 0 0 1 0 3.4L17 19"/>
                                </svg>
                            </div>
                            <div class="agent-step-content">
                                <div class="agent-step-name">Planner</div>
                                <div class="agent-step-status">Pending</div>
                            </div>
                        </div>
                        <div class="agent-step pending" id="agent-researcher">
                            <div class="agent-step-icon">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <circle cx="11" cy="11" r="8"/>
                                    <path d="m21 21-4.3-4.3"/>
                                </svg>
                            </div>
                            <div class="agent-step-content">
                                <div class="agent-step-name">Researcher</div>
                                <div class="agent-step-status">Pending</div>
                            </div>
                        </div>
                        <div class="agent-step pending" id="agent-coder">
                            <div class="agent-step-icon">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <polyline points="16 18 22 12 16 6"/>
                                    <polyline points="8 6 2 12 8 18"/>
                                </svg>
                            </div>
                            <div class="agent-step-content">
                                <div class="agent-step-name">Coder</div>
                                <div class="agent-step-status">Pending</div>
                            </div>
                        </div>
                        <div class="agent-step pending" id="agent-reporter">
                            <div class="agent-step-icon">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                                    <polyline points="14 2 14 8 20 8"/>
                                    <line x1="16" y1="13" x2="8" y2="13"/>
                                    <line x1="16" y1="17" x2="8" y2="17"/>
                                    <polyline points="10 9 9 9 8 9"/>
                                </svg>
                            </div>
                            <div class="agent-step-content">
                                <div class="agent-step-name">Reporter</div>
                                <div class="agent-step-status">Pending</div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="control-group">
                    <label>Select Part to Execute:</label>
                    <div class="button-group">
                        <button onclick="startExecution('Part1')" class="btn-primary" id="part1Btn">
                            Run Part1: Landscape analysis
                        </button>
                        <button onclick="startExecution('Part2')" class="btn-primary" id="part2Btn">
                            Run Part2: Technology Position Papers
                        </button>
                    </div>
                </div>

                <div class="control-group">
                    <label>Download Files:</label>
                    <div class="button-group">
                        <button onclick="downloadAll('part1')" class="btn-secondary">
                            All Part1
                        </button>
                        <button onclick="downloadAll('part2')" class="btn-secondary">
                            All Part2
                        </button>
                    </div>
                    <button onclick="downloadAll('all')" class="btn-secondary" style="width: 100%; margin-top: 10px;">
                        Download All Files
                    </button>
                </div>

                <div class="files-section">
                    <h3>
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M4 20h16a2 2 0 0 0 2-2V8a2 2 0 0 0-2-2h-7.93a2 2 0 0 1-1.66-.9l-.82-1.2A2 2 0 0 0 7.93 3H4a2 2 0 0 0-2 2v13c0 1.1.9 2 2 2Z"/>
                        </svg>
                        Generated Files
                    </h3>
                    <div class="file-list" id="fileList">
                        <div class="empty-state">No files available</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="connectionStatus" class="connection-status disconnected">Connecting...</div>

    <script>
        // WebSocket connection
        const socket = io();
        let autoScroll = true;
        let executionRunning = false;

        // Connection status management
        socket.on('connect', function() {
            console.log('Connected to server');
            document.getElementById('connectionStatus').textContent = 'Connected';
            document.getElementById('connectionStatus').className = 'connection-status connected';
            loadFiles();
        });

        socket.on('disconnect', function() {
            console.log('Disconnected from server');
            document.getElementById('connectionStatus').textContent = 'Disconnected';
            document.getElementById('connectionStatus').className = 'connection-status disconnected';
        });

        // Receive log lines
        socket.on('log', function(data) {
            addLogEntry(data);
            updateLogCount();
        });

        // Receive status changes
        socket.on('status', function(data) {
            updateStatus(data);
            // FORCE planner to running state when execution starts
            if (data.status === 'running') {
                // Immediately set planner as running when execution starts
                setAgentStatus('planner', 'running');
            }
            if (data.status === 'completed' || data.status === 'error') {
                executionRunning = false;
                updateButtons();
                loadFiles();
            }
        });

        function addLogEntry(data) {
            const logContainer = document.getElementById('logContainer');

            // Create new line
            const entry = document.createElement('div');
            entry.className = `log-entry log-${data.category || data.type || 'text'}`;

            const messageSpan = document.createElement('span');
            messageSpan.textContent = data.message;

            entry.appendChild(messageSpan);
            logContainer.appendChild(entry);

            if (autoScroll) {
                logContainer.scrollTop = logContainer.scrollHeight;
            }

            // Update agent status based on log message
            updateAgentStatusFromLog(data.message);
        }

        function updateAgentStatusFromLog(message) {
            const lowerMessage = message.toLowerCase();

            // 1. Check for initial planner start message
            if (message.includes('=== Planner Agent Started ===')) {
                setAgentStatus('planner', 'running');
                return;
            }

            // 2. Check for "## Comprehensive Plan" - indicates planner started
            if (message.includes('## Comprehensive Plan')) {
                setAgentStatus('planner', 'running');
                return;
            }

            // 2. Check for "Tool calling â†’ agent_name" pattern from supervisor
            // This means planner is done and supervisor is calling the next agent
            const toolCallingMatch = message.match(/Tool calling\s*(?:â†’|-|>)\s*(\w+)/i);
            if (toolCallingMatch) {
                const agentName = toolCallingMatch[1].toLowerCase();

                // Planner is completed when supervisor starts calling tools
                setAgentStatus('planner', 'completed');

                // Mark previous running agent as completed when a new one starts
                if (window.lastRunningAgent && window.lastRunningAgent !== agentName) {
                    setAgentStatus(window.lastRunningAgent, 'completed');
                }

                // Map tool names to UI agent names
                const toolToAgentMap = {
                    'researcher_agent_tool': 'researcher',
                    'researcher': 'researcher',
                    'coder_agent_tool': 'coder',
                    'coder': 'coder',
                    'reporter_agent_tool': 'reporter',
                    'reporter': 'reporter',
                    'tracker_agent_tool': null,  // Don't show tracker in UI
                    'tracker': null
                };

                const uiAgentName = toolToAgentMap[agentName] || agentName;

                if (uiAgentName && ['researcher', 'coder', 'reporter'].includes(uiAgentName)) {
                    setAgentStatus(uiAgentName, 'running');
                    window.lastRunningAgent = uiAgentName;
                }
                return;
            }

            // 3. Check for agent tool completion messages
            const agentToolCompletedMatch = message.match(/(\w+)\s+Agent\s+Tool\s+completed/i);
            if (agentToolCompletedMatch) {
                const agentName = agentToolCompletedMatch[1].toLowerCase();
                if (['researcher', 'coder', 'reporter'].includes(agentName)) {
                    setAgentStatus(agentName, 'completed');
                    if (window.lastRunningAgent === agentName) {
                        window.lastRunningAgent = null;
                    }
                }
                return;
            }

            // 4. Check for "===== NodeName started/completed =====" pattern (fallback)
            const startedMatch = message.match(/=====\s+(.+?)\s+started\s+=====/i);
            if (startedMatch) {
                const nodeName = startedMatch[1].toLowerCase();
                if (nodeName.includes('planner') || nodeName.includes('router')) {
                    setAgentStatus('planner', 'running');
                } else if (nodeName === 'supervisor') {
                    // Supervisor started - planner must be completed
                    setAgentStatus('planner', 'completed');
                }
                return;
            }

            const completedMatch = message.match(/=====\s+(.+?)\s+completed\s+=====/i);
            if (completedMatch) {
                const nodeName = completedMatch[1].toLowerCase();
                if (nodeName.includes('planner') || nodeName.includes('router')) {
                    setAgentStatus('planner', 'completed');
                }
                return;
            }
        }

        function setAgentStatus(agent, status) {
            const agentElement = document.getElementById(`agent-${agent}`);
            if (!agentElement) return;

            // Remove all status classes
            agentElement.classList.remove('pending', 'running', 'completed');

            // Add new status class
            agentElement.classList.add(status);

            // Update status text
            const statusElement = agentElement.querySelector('.agent-step-status');
            if (statusElement) {
                if (status === 'pending') {
                    statusElement.textContent = 'Pending';
                } else if (status === 'running') {
                    statusElement.textContent = 'Running...';
                } else if (status === 'completed') {
                    statusElement.textContent = 'Completed';
                }
            }

            // Update icon
            const iconElement = agentElement.querySelector('.agent-step-icon svg');
            if (iconElement) {
                if (status === 'running') {
                    // Change to spinner icon
                    iconElement.innerHTML = '<circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="2" fill="none" stroke-dasharray="32" stroke-dashoffset="32" opacity="0.25"/><path d="M12 2a10 10 0 0 1 10 10" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round"/>';
                } else if (status === 'completed') {
                    // Change to check icon
                    iconElement.innerHTML = '<path d="M20 6L9 17l-5-5" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round"/>';
                } else {
                    // Reset to original icon
                    resetAgentIcon(agent, iconElement);
                }
            }
        }

        function resetAgentIcon(agent, iconElement) {
            const icons = {
                'planner': '<path d="M9 5H2v7l6.29 6.29c.94.94 2.48.94 3.42 0l3.58-3.58c.94-.94.94-2.48 0-3.42L9 5Z"/><path d="M6 9.01V9"/><path d="m15 5 6.3 6.3a2.4 2.4 0 0 1 0 3.4L17 19"/>',
                'researcher': '<circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/>',
                'coder': '<polyline points="16 18 22 12 16 6"/><polyline points="8 6 2 12 8 18"/>',
                'reporter': '<path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><polyline points="10 9 9 9 8 9"/>'
            };
            iconElement.innerHTML = icons[agent] || '';
        }

        function resetAgentStatus() {
            const agents = ['planner', 'researcher', 'coder', 'reporter'];
            agents.forEach(agent => {
                setAgentStatus(agent, 'pending');
            });
        }

        function updateStatus(data) {
            const badge = document.getElementById('statusBadge');

            if (data.status === 'running') {
                badge.textContent = `Running - ${data.part}`;
                badge.className = 'status-badge status-running';
                executionRunning = true;
                resetAgentStatus();
                // FORCE planner to start immediately when execution begins
                setAgentStatus('planner', 'running');
            } else if (data.status === 'completed') {
                badge.textContent = 'Completed';
                badge.className = 'status-badge status-completed';
                executionRunning = false;
            } else if (data.status === 'error') {
                badge.textContent = 'Error';
                badge.className = 'status-badge status-error';
                executionRunning = false;
            } else {
                badge.textContent = 'Ready';
                badge.className = 'status-badge status-idle';
                executionRunning = false;
            }

            updateButtons();
        }

        function updateButtons() {
            const part1Btn = document.getElementById('part1Btn');
            const part2Btn = document.getElementById('part2Btn');

            part1Btn.disabled = executionRunning;
            part2Btn.disabled = executionRunning;
        }

        function startExecution(part) {
            if (executionRunning) {
                alert('Already running.');
                return;
            }

            if (!confirm(`Do you want to execute ${part}?`)) {
                return;
            }

            fetch('/api/start', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ part: part })
            })
            .then(response => response.json())
            .then(data => {
                console.log('Execution started:', data);
            })
            .catch(error => {
                console.error('Error:', error);
                alert('An error occurred while starting execution.');
            });
        }

        function loadFiles() {
            fetch('/api/files')
                .then(response => response.json())
                .then(data => {
                    displayFiles(data.files);
                })
                .catch(error => {
                    console.error('Error loading files:', error);
                });
        }

        function displayFiles(files) {
            const fileList = document.getElementById('fileList');

            if (files.length === 0) {
                fileList.innerHTML = '<div class="empty-state">No files available</div>';
                return;
            }

            fileList.innerHTML = '';

            files.forEach(file => {
                const item = document.createElement('div');
                item.className = 'file-item';

                const info = document.createElement('div');
                info.className = 'file-info';

                const partBadge = document.createElement('span');
                partBadge.className = `file-part ${file.part}1-badge`;
                partBadge.textContent = file.part.toUpperCase();

                const name = document.createElement('div');
                name.className = 'file-name';
                name.textContent = file.name;

                const meta = document.createElement('div');
                meta.className = 'file-meta';
                const fileSize = (file.size / 1024).toFixed(2);
                meta.textContent = `${fileSize} KB`;

                info.appendChild(partBadge);
                info.appendChild(name);
                info.appendChild(meta);

                const downloadBtn = document.createElement('button');
                downloadBtn.className = 'download-btn';
                downloadBtn.textContent = 'Download';
                downloadBtn.onclick = () => downloadFile(file.path);

                item.appendChild(info);
                item.appendChild(downloadBtn);
                fileList.appendChild(item);
            });
        }

        function downloadFile(path) {
            window.location.href = `/api/download/${path}`;
        }

        function downloadAll(part) {
            window.location.href = `/api/download-all/${part}`;
        }

        function clearLogs() {
            const logContainer = document.getElementById('logContainer');
            logContainer.innerHTML = '<div class="log-entry log-system"><span class="log-timestamp"></span><span>Logs cleared.</span></div>';
        }

        function toggleAutoScroll() {
            autoScroll = !autoScroll;
            const btn = document.getElementById('autoScrollBtn');
            btn.textContent = `Auto-scroll: ${autoScroll ? 'ON' : 'OFF'}`;
        }

        // Initial load
        window.onload = function() {
            loadFiles();
            // Refresh file list periodically (every 5 seconds)
            setInterval(loadFiles, 5000);
        };
    </script>
</body>
</html>
